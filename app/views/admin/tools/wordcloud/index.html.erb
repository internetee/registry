<% content_for :actions do %>
  <%= link_to t('back'), admin_tools_path, class: 'btn btn-default' %>
<% end %>
<%= render "shared/title", name: t('admin.tools.wordcloud_title') %>

<style>
  .wordcloud-container {
    margin-bottom: 20px;
  }
  .controls-section {
    padding-top: 15px;
    margin-top: 15px;
    border-top: 1px solid #eee;
  }
  .instructions {
    margin-bottom: 15px;
    color: #555;
  }
  .mt-2 {
    margin-top: 10px;
  }
  .wordcloud-container a {
    display: block;
    text-decoration: none;
    padding: 5px;
    border: 1px solid transparent;
    transition: all 0.2s ease;
  }
  .wordcloud-container a:hover {
    border-color: #ddd;
    background-color: #f9f9f9;
    border-radius: 4px;
  }
  .wordcloud-container a small {
    color: #337ab7;
  }
</style>

<div class="row">
  <div class="col-md-12">
    <div class="row">
      <div class="col-md-8">
        <div class="panel panel-default">
          <div class="panel-heading">
            <h3 class="panel-title"><%= t('admin.tools.wordcloud_title') %></h3>
          </div>
          <div class="panel-body text-center">
            <% if @wordcloud_url %>
              <div class="wordcloud-container">
                <%= link_to @wordcloud_url, target: "_blank", title: t('admin.tools.view_full_size') do %>
                  <%= image_tag @wordcloud_url, class: 'img-responsive', alt: t('admin.tools.wordcloud_title') %>
                  <div class="text-center mt-2">
                    <small><i class="fa fa-search-plus"></i> <%= t('admin.tools.click_to_enlarge') %></small>
                  </div>
                <% end %>
                
                <% if @wordcloud_generated_at %>
                  <div class="text-muted mt-2">
                    <small><i class="fa fa-clock-o"></i> <%= t('admin.tools.generated_at', time: l(@wordcloud_generated_at, format: :long)) %></small>
                  </div>
                <% end %>
              </div>
            <% end %>
            <div class="instructions">
              <p><%= t('admin.tools.wordcloud_instructions') %></p>
            </div>
            <%= form_tag admin_tools_wordcloud_path, method: :post, multipart: true do %>
              <div class="row">
                <div class="col-md-12">
                  <div class="form-group">
                    <div class="custom-file-upload">
                      <p class="text-muted"><%= t('admin.tools.custom_file_description') %></p>
                      <%= file_field_tag :domains_file, accept: '.csv', class: 'form-control' %>
                    </div>
                  </div>
                </div>
              </div>
              
              <div class="panel panel-default mt-3">
                <div class="panel-heading">
                  <h4 class="panel-title">
                    <a data-toggle="collapse" href="#advancedOptions">
                      <i class="fa fa-cog"></i> <%= t('admin.tools.advanced_options') %>
                    </a>
                  </h4>
                </div>
                <div id="advancedOptions" class="panel-collapse collapse">
                  <div class="panel-body">
                    <div class="row">
                      <div class="col-md-4">
                        <div class="form-group">
                          <%= label_tag :width, t('admin.tools.wordcloud_width') %>
                          <%= number_field_tag :width, @config['width'], min: 400, max: 2000, step: 100, class: 'form-control' %>
                        </div>
                      </div>
                      <div class="col-md-4">
                        <div class="form-group">
                          <%= label_tag :height, t('admin.tools.wordcloud_height') %>
                          <%= number_field_tag :height, @config['height'], min: 400, max: 2000, step: 100, class: 'form-control' %>
                        </div>
                      </div>
                      <div class="col-md-4">
                        <div class="form-group">
                          <%= label_tag :max_words, t('admin.tools.wordcloud_max_words') %>
                          <%= number_field_tag :max_words, @config['max_words'], min: 100, max: 1000, step: 50, class: 'form-control' %>
                        </div>
                      </div>
                    </div>
                    
                    <div class="row">
                      <div class="col-md-6">
                        <div class="form-group">
                          <%= label_tag :batch_size, t('admin.tools.batch_size') %>
                          <%= number_field_tag :batch_size, @config['batch_size'], min: 100, max: 1000, step: 50, class: 'form-control' %>
                          <small class="text-muted"><%= t('admin.tools.batch_size_help') %></small>
                        </div>
                      </div>
                      <div class="col-md-6">
                        <div class="form-group">
                          <%= label_tag :background_color, t('admin.tools.wordcloud_background') %>
                          <%= select_tag :background_color, 
                              options_for_select([
                                ['White', 'white'], 
                                ['Black', 'black'],
                                ['Transparent', 'transparent'],
                                ['Light Gray', '#f0f0f0']
                              ], @config['background_color']), 
                              class: 'form-control' %>
                        </div>
                      </div>
                    </div>

                    <div class="row">
                      <div class="col-md-6">
                        <div class="form-group">
                          <%= label_tag :min_word_length, t('admin.tools.min_word_length') %>
                          <%= number_field_tag :min_word_length, @config['min_word_length'], min: 1, max: 5, class: 'form-control' %>
                        </div>
                      </div>
                      <div class="col-md-6">
                        <div class="form-group">
                          <div class="checkbox" style="margin-top: 30px;">
                            <label>
                              <%= check_box_tag :include_numbers, '1', @config['include_numbers'] %>
                              <%= t('admin.tools.include_numbers') %>
                            </label>
                          </div>
                        </div>
                      </div>
                    </div>
                  
                    <div class="form-group">
                      <%= label_tag :special_terms, t('admin.tools.special_terms') %>
                      <%= text_field_tag :special_terms, @config['special_terms'].is_a?(Array) ? @config['special_terms'].join(', ') : '', 
                          class: 'form-control',
                          placeholder: t('admin.tools.special_terms_placeholder') %>
                      <small class="text-muted"><%= t('admin.tools.special_terms_help') %></small>
                    </div>
                    
                    <div class="form-group">
                      <%= label_tag :additional_stopwords, t('admin.tools.additional_stopwords') %>
                      <%= text_area_tag :additional_stopwords, @config['additional_stopwords'].is_a?(Array) ? @config['additional_stopwords'].join(', ') : '', 
                          rows: 3, 
                          placeholder: t('admin.tools.stopwords_placeholder'),
                          class: 'form-control' %>
                      <small class="text-muted"><%= t('admin.tools.stopwords_help') %></small>
                    </div>
                  </div>
                </div>
              </div>
              
              <%= submit_tag t('admin.tools.generate_wordcloud'), class: 'btn btn-primary btn-lg mt-3' %>
            <% end %>
          </div>
        </div>
      </div>

      <div class="col-md-4">
        <div class="panel panel-default">
          <div class="panel-heading">
            <h3 class="panel-title"><%= t('admin.tools.top_words') %></h3>
          </div>
          <div class="panel-body">
            <% if @top_words && @top_words.any? %>
              <ol>
                <% @top_words.each do |word, count| %>
                  <li><strong><%= word %></strong>: <%= count %></li>
                <% end %>
              </ol>
            <% else %>
              <p class="text-muted"><%= t('admin.tools.top_words_empty') %></p>
            <% end %>
          </div>
        </div>
      </div>
    </div>
  </div>
</div> 